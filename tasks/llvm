#!/usr/bin/env bash

# llvm install script
# usage ./llvm 3.7.0

set -ex

ver=$1

LLVM=http://llvm.org/releases/$ver/llvm-$ver.src.tar.xz
CLANG=http://llvm.org/releases/$ver/cfe-$ver.src.tar.xz
LLDB=http://llvm.org/releases/$ver/lldb-$ver.src.tar.xz
EXTRA=http://llvm.org/releases/$ver/clang-tools-extra-$ver.src.tar.xz
COMPILERRT=http://llvm.org/releases/$ver/compiler-rt-$ver.src.tar.xz
LIBCPP=http://llvm.org/releases/$ver/libcxx-$ver.src.tar.xz
LIBCPPABI=http://llvm.org/releases/$ver/libcxxabi-$ver.src.tar.xz
LIBUNWIND=http://llvm.org/releases/$ver/libunwind-$ver.src.tar.xz

cd ~
mkdir -p local/bin
mkdir -p local/llvm-v$ver && cd local/llvm-v$ver
wget "$LLVM" &
wget "$CLANG" &
wget "$LLDB" &
wget "$EXTRA" &
wget "$COMPILERRT" &
wget "$LIBCPP" &
wget "$LIBCPPABI" &
wget "$LIBUNWIND" &

for job in $(jobs -p); do
  wait "$job"
done

mkdir -p src && cd src
tar xf ../llvm-$ver.src.tar.xz --strip-components=1
# clang goes in tools/clang
mkdir -p tools/clang && cd tools/clang
tar xf ../../../cfe-$ver.src.tar.xz --strip-components=1
# copy scan-build directory into a bin directory - does not make install
# ignore scan-view, can just open html report
find tools/scan-build/ -type f -exec cp {} ~/local/bin/ \;
# lldb goes in tools/lldb
cd ../..
mkdir -p tools/lldb && cd tools/lldb
tar xf ../../../lldb-$ver.src.tar.xz --strip-components=1
# extra goes in tools/clang/tools/extra
mkdir -p tools/extra && cd tools/extra
tar xf ../../../../../clang-tools-extra-$ver.src.tar.xz --strip-components=1
# compiler-rt goes in projects/compiler-rt
cd ../../../../
mkdir -p projects/compiler-rt && cd projects/compiler-rt
tar xf ../../../compiler-rt-$ver.src.tar.xz --strip-components=1
cd ..
mkdir -p libcxxabi && cd libcxxabi
tar xf ../../../libcxxabi-$ver.src.tar.xz --strip-components=1
cd ..
mkdir -p libcxx && cd libcxx
tar xf ../../../libcxx-$ver.src.tar.xz --strip-components=1
cd ..
mkdir -p libunwind && cd libunwind
tar xf ../../../libunwind-$ver.src.tar.xz --strip-components=1

# back to source
cd ~/local/llvm-v$ver

# don't pollute src dir with build stuff
mkdir build
cd build
cmake \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/usr/local \
  ../src
make -j8
make install

rm -rf ~/local-llvm-v$ver

echo "Remember to:"
echo "export PATH=\$HOME/local/bin:\$PATH"
