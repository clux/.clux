---
- hosts: kjttks
  connection: local
  user: root
  gather_facts: no

  tasks:
    - name: sudo
      pacman: name=sudo state=installed

    - name: ensure {{ desktop_user }} exists
      user:
        name={{ desktop_user }}
        state=present
        groups=audio,video,games,rfkill,uucp,wheel
        # TODO: generate ssh keys here
        # TODO: docker group means this can't be re-run if after install (lest we lose it)

    - name: allow wheel users to sudo with pass
      lineinfile:
        dest=/etc/sudoers
        line='%wheel ALL=(ALL) ALL'
        validate='visudo -cf %s'

    - name: enable multilib for steam
      lineinfile:
        dest=/etc/pacman.conf
        backrefs=yes
        regexp="^\#\[multilib\]"
        line="[multilib]\nInclude = /etc/pacman.d/mirrorlist"

    - name: "Update cache after changing pacman settings"
      pacman: update_cache=yes

    - name: install display drivers and choice dependencies in one go
      pacman: name="nvidia nvidia-libgl libevdev" state=installed

    - name: install core display utilities
      pacman: name={{ item }} state=installed
      with_items:
        - alsa-utils
        - cinnamon
        - lightdm
        - lightdm-gtk-greeter
        - ttf-dejavu
        - ttf-liberation
        - guake
        - chromium

    - name: enable lightdm gtk greeter
      lineinfile:
        dest=/etc/lightdm/lightdm.conf
        backrefs=yes
        regexp="^#greeter-session\="
        line="greeter-session=lightdm-gtk-greeter"

    - name: disable overly fancy grub that can be laggy
      lineinfile:
        dest=/etc/default/grub
        line="GRUB_TERMINAL_OUTPUT=console"
      notify: update grub

    - name: enable lightdm
      service: name=lightdm enabled=yes

  handlers:
    - name: update grub
      command: grub-mkconfig -o /boot/grub/grub.cfg && grub-install /dev/sda

  roles:
    - bootstrap
