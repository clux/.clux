#!/bin/bash
set -e
if [ -z "$VIRTUAL_ENV" ]; then
  source venv.sh
fi

if [[ $1 == "bootstrap" ]]; then
  if [[ $EUID -ne 0 ]]; then
    echo "Must run bootstrap role as root"
    exit 1
  fi
  ansible-playbook -i hosts -l "$(hostname)" bootstrap.yml -vv
elif [[ $1 == "secrets" ]]; then
  if [[ $EUID -eq 0 ]]; then
    echo "This role is not indended to be run as root"
    exit 1
  fi
  # interactive steps with passwords and key pasting here:
  set -x
  # First sudo:
  sudo chown -R "$USER:$USER" /usr/local
  # Decrypting gogs.yml - password please:
  gpg -d vars/gogs.yml.gpg > vars/gogs.yml
  # Adding main_id to keychain - password please:
  keychain --timeout 30 --quiet --host agent ~/.ssh/main_id
  source ~/.keychain/agent-sh
  ansible-playbook -i hosts -l "$(hostname)" secrets.yml -vv
  for repo in ssh gpg mumble cisco; do
    echo "Installing $repo"
    ~/$repo/install.sh
  done
  mkdir -p ~/repos && cd ~/repos
  git clone git@github.com:clux/dotfiles.git
  cd dotfiles
  make config
  make ui
else
  # shellcheck disable=SC2046
  ansible-playbook -i hosts -l "$(hostname)" site.yml --tags="$1" -vv \
    $(test -n "$DOTCLUX_FULL" && echo "-e upgrade_tasks=1" || echo "") \
    --ask-become-pass
fi
